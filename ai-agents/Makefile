# Makefile for AI-Powered Boutique Agents

.PHONY: help build up down test logs clean dev mcp-test

# Default target
help:
	@echo "ğŸ¤– AI-Powered Boutique Agents - Docker Commands"
	@echo ""
	@echo "Available commands:"
	@echo "  make build     - Build all Docker images"
	@echo "  make up        - Start all services"
	@echo "  make dev       - Start development server with hot reload"
	@echo "  make mcp       - Start only MCP servers"
	@echo "  make test      - Run tests in Docker"
	@echo "  make mcp-test  - Test MCP server functionality"
	@echo "  make logs      - Show logs from all services"
	@echo "  make down      - Stop all services"
	@echo "  make clean     - Clean up containers and images"
	@echo ""

# Build all images
build:
	@echo "ğŸ”¨ Building Docker images..."
	docker-compose build

# Start all services
up:
	@echo "ğŸš€ Starting all services..."
	docker-compose up -d
	@echo "âœ… Services started!"
	@echo "ğŸ“Š Boutique API MCP: http://localhost:8080"
	@echo "ğŸ“ˆ Analytics MCP: http://localhost:8081"
	@echo "ğŸ¤– ML Models MCP: http://localhost:8082"

# Start development server
dev:
	@echo "ğŸ› ï¸  Starting development server..."
	docker-compose up dev-server
	@echo "ğŸ”¥ Development server with hot reload started!"

# Start only MCP servers
mcp:
	@echo "ğŸ”Œ Starting MCP servers..."
	docker-compose up -d boutique-api-mcp analytics-mcp ml-models-mcp
	@echo "âœ… MCP servers started!"

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	docker-compose --profile testing run --rm test-runner
	@echo "âœ… Tests completed!"

# Test MCP server functionality
mcp-test:
	@echo "ğŸ” Testing MCP server functionality..."
	docker-compose up -d boutique-api-mcp
	@echo "â³ Waiting for server to start..."
	sleep 10
	@echo "ğŸ§ª Running MCP tests..."
	docker-compose exec boutique-api-mcp python -c "\
	import asyncio; \
	from ai_agents.mcp_servers.boutique_api import BoutiqueAPIMCPServer; \
	async def test(): \
		server = BoutiqueAPIMCPServer(); \
		await server.initialize(); \
		products = await server._get_products({}); \
		print(f'âœ… Found {len(products[\"products\"])} products'); \
		search = await server._search_products({'query': 'watch'}); \
		print(f'âœ… Search found {len(search[\"products\"])} products'); \
		print('ğŸ‰ MCP server tests passed!'); \
	asyncio.run(test())"

# Show logs
logs:
	@echo "ğŸ“‹ Showing service logs..."
	docker-compose logs -f

# Stop all services
down:
	@echo "ğŸ›‘ Stopping all services..."
	docker-compose down
	@echo "âœ… All services stopped!"

# Clean up
clean:
	@echo "ğŸ§¹ Cleaning up..."
	docker-compose down -v --remove-orphans
	docker system prune -f
	@echo "âœ… Cleanup completed!"

# Quick status check
status:
	@echo "ğŸ“Š Service Status:"
	docker-compose ps

# Build and start in one command
quick-start: build mcp
	@echo "ğŸš€ Quick start completed!"
	@echo "ğŸ”— Test the MCP server: make mcp-test"